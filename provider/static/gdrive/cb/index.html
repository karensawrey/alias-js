<html>
    <head>
        <title>Please wait</title>

        <script type="application/javascript" src="/jquery-3.4.1.min.js"></script>
        <script type="application/javascript" src="/header.js"></script>
        <script type="application/javascript" src="/sodium.js"></script>
        <script type="application/javascript" src="/anychain.js"></script>
        <script type="application/javascript" src="/alias.js"></script>

    </head>
    <body>
        <h1>Please wait...</h1>
        <p>You'll be redirected soon.</p>
    <script>
        function run() {
            const url = new URL(window.location.href);
            let token = url.searchParams.get("token");
            if (!token) {
                alert("no token were returned!");
            }

            try {
                token = JSON.parse(token);
            } catch(e) {
                alert("bad token format");
            }

            const sess = currentSession();
            if (!sess) {
                alert("session were closed");
            }

            mutateIdentity(sess, function(idty) {
                idty.gdrive = { token: token };
            }).then(() => {
                window.location.href = "/";
            }).catch(console.error);
        };
    </script>
    </body>
</html>
